<!-- sql_console.html -->
{% extends "base.html" %}

{% block title %}SQL консоль - DataBoard{% endblock %}

{% block page_title %}SQL консоль{% endblock %}

{% block content %}
<div class="top-section">
    <h1 class="main-title">SQL консоль</h1>
    <p class="main-description">Выполняйте запросы и сохраняйте результаты</p>
</div>

<div class="card mb-4">
    <div class="card-top" onclick="toggleSection('editorSection', 'editorIcon')" style="cursor: pointer;">
        <div class="flex justify-between align-center">
            <h3><i class="fas fa-terminal"></i> Редактор SQL</h3>
            <i class="fas fa-chevron-down" id="editorIcon"></i>
        </div>
    </div>
    <div class="card-body" id="editorSection" style="display: none;">
        <div class="form-group">
            <label class="form-label">SQL запрос</label>
            <textarea id="sqlEditor" class="form-input" rows="8" 
                      placeholder="SELECT * FROM table_name WHERE condition = %s"
                      style="font-family: monospace; font-size: 13px;">
{% if request.query_params.get('table') %}SELECT * FROM {{ request.query_params.get('table') }} LIMIT 200{% endif %}</textarea>
        </div>
        
        <div class="form-group">
            <label class="form-label">Параметры</label>
            <div class="flex gap-3 mb-2">
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                    <input type="radio" name="paramType" value="array" checked onchange="changeParamType()">
                    <span>Массив</span>
                </label>
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                    <input type="radio" name="paramType" value="object" onchange="changeParamType()">
                    <span>Объект</span>
                </label>
            </div>
            <textarea id="sqlParams" class="form-input" rows="4" 
                      placeholder='["value1", "value2"]'
                      style="font-family: monospace; font-size: 13px;"></textarea>
            <small class="form-note" id="paramNote">
                Для позиционных параметров используйте массив: ["value1", "value2"]
            </small>
        </div>
        
        <div class="form-group">
            <label class="form-label">Формат сохранения</label>
            <select id="saveFormat" class="form-input">
                <option value="csv">Excel (.xlsx)</option>
                <option value="json">JSON (.json)</option>
            </select>
        </div>
        
        <div class="flex gap-3 mt-4">
            <button onclick="runSQL()" class="btn btn-blue" style="flex: 1;">
                <i class="fas fa-play"></i> Выполнить
            </button>
            <button onclick="saveResults()" class="btn btn-green" style="flex: 1;">
                <i class="fas fa-download"></i> Сохранить
            </button>
            <button onclick="clearEditor()" class="btn">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-top" onclick="toggleSection('tablesSection', 'tablesIcon')" style="cursor: pointer;">
        <div class="flex justify-between align-center">
            <h3><i class="fas fa-database"></i> База данных</h3>
            <i class="fas fa-chevron-down" id="tablesIcon"></i>
        </div>
    </div>
    <div class="card-body" id="tablesSection" style="display: none;">
        <div class="form-group">
            <input type="text" id="searchTable" class="form-input" 
                   placeholder="Поиск таблицы..." onkeyup="filterTables()">
        </div>
        <div style="max-height: 300px; overflow-y: auto; padding: 8px; background: #f8f9fa; border-radius: 6px; border: 1px solid #dee2e6;">
            <div class="grid grid-cols-2" id="tablesList">
                {% for table in tables %}
                <div class="btn text-left" 
                     onclick="insertTable('{{ table }}')"
                     style="justify-content: start; padding: 10px;">
                    <i class="fas fa-table"></i> {{ table }}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-top" onclick="toggleSection('examplesSection', 'examplesIcon')" style="cursor: pointer;">
        <div class="flex justify-between align-center">
            <h3><i class="fas fa-bolt"></i> Примеры запросов</h3>
            <i class="fas fa-chevron-down" id="examplesIcon"></i>
        </div>
    </div>
    <div class="card-body" id="examplesSection" style="display: none;">
        <div class="flex flex-col gap-2">
            <button class="btn btn-small text-left" onclick="loadExample('select_all')">
                <i class="fas fa-search"></i> SELECT * FROM enterprises
            </button>
            <button class="btn btn-small text-left" onclick="loadExample('select_where')">
                <i class="fas fa-filter"></i> SELECT с WHERE
            </button>
            <button class="btn btn-small text-left" onclick="loadExample('join')">
                <i class="fas fa-link"></i> JOIN таблиц
            </button>
            <button class="btn btn-small text-left" onclick="loadExample('aggregate')">
                <i class="fas fa-calculator"></i> Агрегатные функции
            </button>
            <button class="btn btn-small text-left" onclick="loadExample('params_array')">
                <i class="fas fa-list"></i> Параметры (массив)
            </button>
            <button class="btn btn-small text-left" onclick="loadExample('params_object')">
                <i class="fas fa-object-group"></i> Параметры (объект)
            </button>
        </div>
    </div>
</div>

<div class="card mb-4" id="resultPanel" style="display: none;">
    <div class="card-top" onclick="toggleSection('resultsSection', 'resultsIcon')" style="cursor: pointer;">
        <div class="flex justify-between align-center">
            <div class="flex align-center gap-4">
                <h3><i class="fas fa-table-list"></i> Результаты запроса</h3>
                <span style="opacity: 0.7;">Найдено: <span id="rowCount">0</span></span>
                <span style="opacity: 0.7;">Время: <span id="timeTaken">0</span> мс</span>
            </div>
            <i class="fas fa-chevron-down" id="resultsIcon"></i>
        </div>
    </div>
    <div class="card-body" id="resultsSection" style="display: none;">
        <div class="table-wrapper">
            <table id="resultTable" class="compact-table">
            </table>
        </div>
        <div class="flex justify-end mt-3">
            <button onclick="copyTable()" class="btn btn-small">
                <i class="fas fa-copy"></i> Копировать таблицу
            </button>
        </div>
    </div>
</div>

<script>
// Функция для переключения конкретной секции
function toggleSection(sectionId, iconId) {
    const section = document.getElementById(sectionId);
    const icon = document.getElementById(iconId);
    
    if (section.style.display === 'none' || section.style.display === '') {
        section.style.display = 'block';
        if (icon) {
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
        }
    } else {
        section.style.display = 'none';
        if (icon) {
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        }
    }
    
    // Сохраняем состояние в localStorage
    localStorage.setItem(sectionId, section.style.display);
}

// Восстанавливаем состояние секций при загрузке
document.addEventListener('DOMContentLoaded', function() {
    const sections = [
        {id: 'editorSection', icon: 'editorIcon'},
        {id: 'tablesSection', icon: 'tablesIcon'},
        {id: 'examplesSection', icon: 'examplesIcon'},
        {id: 'resultsSection', icon: 'resultsIcon'}
    ];
    
    sections.forEach(({id, icon}) => {
        const section = document.getElementById(id);
        const iconElement = document.getElementById(icon);
        
        if (section && iconElement) {
            const savedState = localStorage.getItem(id);
            if (savedState !== null) {
                section.style.display = savedState;
                if (savedState === 'none') {
                    iconElement.classList.remove('fa-chevron-up');
                    iconElement.classList.add('fa-chevron-down');
                } else {
                    iconElement.classList.remove('fa-chevron-down');
                    iconElement.classList.add('fa-chevron-up');
                }
            } else {
                // Устанавливаем начальное состояние
                if (id === 'resultsSection') {
                    section.style.display = 'none';
                    iconElement.classList.remove('fa-chevron-up');
                    iconElement.classList.add('fa-chevron-down');
                } else {
                    section.style.display = 'none';
                    iconElement.classList.remove('fa-chevron-up');
                    iconElement.classList.add('fa-chevron-down');
                }
            }
        }
    });
});

let lastQueryDuration = 0;

function insertTable(tableName) {
    const editor = document.getElementById('sqlEditor');
    const cursorPos = editor.selectionStart;
    const text = editor.value;
    editor.value = text.substring(0, cursorPos) + tableName + text.substring(cursorPos);
    editor.focus();
}

function filterTables() {
    const search = document.getElementById('searchTable').value.toLowerCase();
    const items = document.querySelectorAll('#tablesList > div');
    
    items.forEach(item => {
        const tableName = item.textContent.toLowerCase();
        if (tableName.includes(search)) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
}

function changeParamType() {
    const paramType = document.querySelector('input[name="paramType"]:checked').value;
    const note = document.getElementById('paramNote');
    
    if (paramType === 'array') {
        note.textContent = 'Для позиционных параметров используйте массив: ["value1", "value2"]';
        document.getElementById('sqlParams').placeholder = '["value1", "value2"]';
    } else {
        note.textContent = 'Для именованных параметров используйте объект: {"param1": "value1", "param2": "value2"}';
        document.getElementById('sqlParams').placeholder = '{"param1": "value1", "param2": "value2"}';
    }
}

function loadExample(type) {
    const examples = {
        select_all: {
            query: "SELECT * FROM enterprises LIMIT 100",
            params: "[]",
            paramType: "array"
        },
        select_where: {
            query: "SELECT * FROM fields WHERE is_irrigated = true LIMIT 100",
            params: "[]",
            paramType: "array"
        },
        join: {
            query: `SELECT 
    p.planting_id,
    e.name as enterprise_name,
    f.field_name,
    c.crop_name,
    p.planting_date,
    p.expected_harvest_date,
    p.seed_amount_kg
FROM plantings p
JOIN fields f ON p.field_id = f.field_id
JOIN enterprises e ON f.enterprise_id = e.enterprise_id
JOIN crops c ON p.crop_id = c.crop_id
LIMIT 50`,
            params: "[]",
            paramType: "array"
        },
        aggregate: {
            query: `SELECT 
    c.crop_type,
    COUNT(*) as plantings_count,
    SUM(p.seed_amount_kg) as total_seeds_kg,
    AVG(p.seed_amount_kg) as avg_seeds_per_planting
FROM plantings p
JOIN crops c ON p.crop_id = c.crop_id
GROUP BY c.crop_type
ORDER BY plantings_count DESC`,
            params: "[]",
            paramType: "array"
        },
        params_array: {
            query: "SELECT * FROM harvests WHERE yield_kg > %s AND is_certified = %s LIMIT 50",
            params: '[50000, true]',
            paramType: "array"
        },
        params_object: {
            query: "SELECT * FROM field_operations WHERE operation_type = %(op_type)s AND cost > %(min_cost)s",
            params: '{"op_type": "Полив", "min_cost": 20000}',
            paramType: "object"
        },
        params_object_numeric: {
            query: "SELECT * FROM crops WHERE growing_season_days > %s AND is_annual = %s",
            params: '{"0": 100, "1": true}',
            paramType: "object"
        }
    };
    
    if (examples[type]) {
        document.getElementById('sqlEditor').value = examples[type].query;
        document.getElementById('sqlParams').value = examples[type].params;
        
        // Устанавливаем правильный тип параметров
        if (examples[type].paramType === 'object') {
            document.querySelector('input[name="paramType"][value="object"]').checked = true;
        } else {
            document.querySelector('input[name="paramType"][value="array"]').checked = true;
        }
        changeParamType();
    }
}

function clearEditor() {
    document.getElementById('sqlEditor').value = '';
    document.getElementById('sqlParams').value = '[]';
    document.getElementById('resultPanel').style.display = 'none';
    document.getElementById('searchTable').value = '';
    filterTables();
}

async function runSQL() {
    const sql = document.getElementById('sqlEditor').value.trim();
    const params = document.getElementById('sqlParams').value.trim();
    
    if (!sql) {
        alert('Введите SQL запрос');
        return;
    }
    
    const startTime = performance.now();
    
    try {
        let paramsObj = {};
        if (params) {
            try {
                paramsObj = JSON.parse(params);
            } catch (e) {
                alert('Ошибка в параметрах JSON: ' + e.message);
                return;
            }
        }
        
        const paramType = document.querySelector('input[name="paramType"]:checked').value;
        let requestParams = {};
        
        if (paramType === 'array' && Array.isArray(paramsObj)) {
            // Для массива создаем объект с числовыми ключами
            paramsObj.forEach((value, index) => {
                requestParams[index] = value;
            });
        } else if (paramType === 'object' && typeof paramsObj === 'object') {
            // Для объекта передаем как есть
            requestParams = paramsObj;
        } else {
            alert('Неверный формат параметров');
            return;
        }
        
        const response = await fetch('/api/run_sql', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: new URLSearchParams({
                sql: sql,
                params: JSON.stringify(requestParams)
            })
        });
        
        const result = await response.json();
        const endTime = performance.now();
        lastQueryDuration = Math.round(endTime - startTime);
        
        if (result.ok) {
            showResults(result.data);
            document.getElementById('rowCount').textContent = result.count;
            document.getElementById('timeTaken').textContent = lastQueryDuration;
            document.getElementById('resultPanel').style.display = 'block';
            toggleSection('resultsSection', 'resultsIcon');
        } else {
            alert('Ошибка: ' + result.error);
        }
    } catch (e) {
        alert('Ошибка: ' + e.message);
    }
}

async function saveResults() {
    const sql = document.getElementById('sqlEditor').value.trim();
    const params = document.getElementById('sqlParams').value.trim();
    const format = document.getElementById('saveFormat').value;
    
    if (!sql) {
        alert('Введите SQL запрос');
        return;
    }
    
    try {
        let paramsObj = {};
        if (params) {
            try {
                paramsObj = JSON.parse(params);
            } catch (e) {
                alert('Ошибка в параметрах JSON: ' + e.message);
                return;
            }
        }
        
        const paramType = document.querySelector('input[name="paramType"]:checked').value;
        let requestParams = {};
        
        if (paramType === 'array' && Array.isArray(paramsObj)) {
            // Для массива создаем объект с числовыми ключами
            paramsObj.forEach((value, index) => {
                requestParams[index] = value;
            });
        } else if (paramType === 'object' && typeof paramsObj === 'object') {
            // Для объекта передаем как есть
            requestParams = paramsObj;
        } else {
            alert('Неверный формат параметров');
            return;
        }
        
        const formData = new FormData();
        formData.append('sql', sql);
        formData.append('params', JSON.stringify(requestParams));
        formData.append('format', format);
        
        const response = await fetch('/api/save_sql', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = `sql_result_${new Date().toISOString().slice(0,10)}`;
            
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="?([^"]+)"?/);
                if (filenameMatch) {
                    filename = filenameMatch[1];
                }
            }
            
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        } else {
            const result = await response.json();
            alert('Ошибка: ' + (result.error || 'Ошибка'));
        }
    } catch (e) {
        alert('Ошибка: ' + e.message);
    }
}

function showResults(data) {
    if (!data || data.length === 0) {
        document.getElementById('resultTable').innerHTML = 
            '<tr><td colspan="100" style="text-align: center; padding: 40px; opacity: 0.6;">Нет данных</td></tr>';
        return;
    }
    
    const table = document.getElementById('resultTable');
    const headers = Object.keys(data[0]);
    
    let html = '<thead><tr>';
    headers.forEach(header => {
        html += `<th>${header}</th>`;
    });
    html += '</tr></thead>';
    
    html += '<tbody>';
    data.forEach((row, index) => {
        html += '<tr>';
        headers.forEach(header => {
            let value = row[header];
            if (value === null || value === undefined) {
                value = '<span style="opacity: 0.4;">—</span>';
            } else if (typeof value === 'object') {
                value = '<span style="font-family: monospace; font-size: 12px; background: #f8f9fa; padding: 4px 8px; border-radius: 4px;">' + JSON.stringify(value, null, 2) + '</span>';
            } else if (typeof value === 'string' && value.length > 100) {
                value = '<span title="' + value + '" style="cursor: help;">' + value.substring(0, 100) + '...</span>';
            } else if (typeof value === 'boolean') {
                value = value ? '✓' : '✗';
            }
            html += `<td>${value}</td>`;
        });
        html += '</tr>';
    });
    html += '</tbody>';
    
    table.innerHTML = html;
}

function copyTable() {
    const table = document.getElementById('resultTable');
    let text = '';
    
    const headers = table.querySelectorAll('th');
    const headerText = Array.from(headers).map(th => th.textContent).join('\t');
    text += headerText + '\n';
    
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const rowText = Array.from(cells).map(cell => {
            let cellText = cell.textContent || cell.innerText;
            if (cellText.includes('—')) cellText = '';
            cellText = cellText.replace(/\n/g, ' ');
            return cellText;
        }).join('\t');
        text += rowText + '\n';
    });
    
    navigator.clipboard.writeText(text).then(() => {
        alert('Таблица скопирована');
    });
}
</script>
{% endblock %}